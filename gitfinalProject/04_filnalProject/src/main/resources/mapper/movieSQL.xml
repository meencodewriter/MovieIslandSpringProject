<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="movie">
	<insert id="insertMovie" parameterType="movie">
	insert into movie_tbl values
	(movie_seq.nextval, #{movieTitle}, #{movieDirector}, #{movieActor}, #{movieGenre}, #{movieTime}, #{movieDate}, #{movieRating}, #{movieContent}, #{filmSociety}, #{classicSociety}, #{specialMovie}, #{enrollMember}, #{movieType})
	
	<selectKey resultType="_int" order="AFTER" keyProperty="movieNo">
		select max(movie_no) from movie_tbl
	</selectKey>
	</insert>
	<insert id="insertMainFile" parameterType="movieFile">
		insert into movie_file values(movie_file_seq.nextval, #{movieFileName}, #{movieFilePath}, '메인', #{movieNo})
	</insert>
	<insert id="insertPostFile" parameterType="movieFile">
		insert into movie_file values(movie_file_seq.nextval, #{movieFileName}, #{movieFilePath}, '포스트', #{movieNo})
	</insert>
	<insert id="insertmovieVideo" parameterType="movieVideo">
		insert into movie_video values(movie_video_seq.nextval, #{videoLink}, #{movieNo})
	</insert>
	<select id="movieList" resultType="movie">
		select * from movie_tbl
	</select>
	<select id="selectMovieAll" resultType="movie">
		select 
		 	movie_no as movieNo,
			movie_title as movieTitle,
			movie_director as movieDirector,
			movie_actor as movieActor,
			movie_genre as movieGenre,
			movie_time as movieTime,
			to_char(movie_date,'yyyy-mm-dd')  as movieDate,
			movie_rating as movieRating,
			movie_content as movieContent,
			film_society as filmSociety,
			classic_society as classicSociety,
			special_movie as specialMovie,
			enroll_member as enrollMember,
			movie_type as movieType
		 from movie_tbl
	</select>
	<!-- movie_file 메인만 출력 -->
	<select id="selectMovieFile" resultType="movieFile" parameterType="_int">
			select 
			movie_file_no as movieFileNo,
			movie_file_name as movieFileName,
			movie_file_path as movieFilePath,
			movie_file_category as movieFileCategory,
			movie_no as movieNo
			from movie_file where movie_file_category='메인' and movie_no=#{movieNo}
	</select>
	<!-- movie_file 전부 출력 -->
	<select id="selectmovieFileAll" resultType="movieFile" parameterType="_int">
			select 
			movie_file_no as movieFileNo,
			movie_file_name as movieFileName,
			movie_file_path as movieFilePath,
			movie_file_category as movieFileCategory,
			movie_no as movieNo
			from movie_file where movie_no=#{movieNo}
	</select>
	<select id="selectMoviePost" resultType="movieFile" parameterType="_int">
		select 
			movie_file_no as movieFileNo,
			movie_file_name as movieFileName,
			movie_file_path as movieFilePath,
			movie_file_category as movieFileCategory,
			movie_no as movieNo
			from movie_file where movie_file_category='포스트' and movie_no=#{movieNo}
	</select>
	<select id="selectFileList" resultType="movieFile" parameterType="_int">
		select 
			movie_file_no as movieFileNo,
			movie_file_name as movieFileName,
			movie_file_path as movieFilePath,
			movie_file_category as movieFileCategory,
			movie_no as movieNo
		from movie_file where movie_no=#{movieNo}
	</select>
	<select id="selectOneMovie" parameterType="_int" resultType="movie">
				select
			 	movie_no as movieNo,
				movie_title as movieTitle,
				movie_director as movieDirector,
				movie_actor as movieActor,
				movie_genre as movieGenre,
				movie_time as movieTime,
				to_char(movie_date,'yyyy-mm-dd')  as movieDate,
				movie_rating as movieRating,
				movie_content as movieContent,
				film_society as filmSociety,
				classic_society as classicSociety,
				special_movie as specialMovie,
				enroll_member as enrollMember,
				movie_type as movieType
			 from movie_tbl where movie_no=#{movieNo}
		</select>
	<select id="selectOneMovieVideo" parameterType="_int" resultType="movieVideo">
		select 
			movie_video_no as videoNo,
			movie_video_link as videoLink
		from movie_video where movie_no=#{movieNo}
	</select>
	<insert id="insertReview" parameterType="review" >
		insert into review values(review_seq.nextval,#{movieNo},#{reviewContent},#{movieScore},to_char(sysdate,'yyyy-mm-dd'),#{memberId})
		<selectKey  resultType="_int" order="AFTER" keyProperty="reviewCommentNo">
			select max(review_comment_no) from review
		</selectKey>		
	</insert>
	<insert id="insertWatchPoint" parameterType="reviewWatch" >
		insert into watch_point values(watch_point_seq.nextval,#{reviewCommentNo},#{story},#{actor},#{ost},#{videoVisual},#{production})
	</insert>
	<select id="getOneReview" parameterType="String" resultType="review">
		select
			member_id as memberId
		from
			review
		where
			member_id = #{memberId}
	</select>
	<select id="oneMovieAllReview" parameterType="_int" resultType="review">
		select
			review_comment_no as reviewCommentNo,
			movie_no as movieNo,
			review_content as reviewContent,
			movie_score as movieScore,
			review_date as reviewDate,
			member_id as memberId,
			watch_point_no as watchPointNo,
			review_comment_no as reviewCommentNo,
			story as story,
			actor as actor,
			ost as ost,
			video_visual as videoVisual,
			production as production
		from review join watch_point using(review_comment_no)
		where movie_no=#{movieNo}			
	</select>
	
	<select id="watchPointAll" parameterType="_int" resultType="reviewWatch">
		select
			watch_point_no as watchPointNo,
			review_comment_no as reviewCommentNo,
			story as story,
			actor as actor,
			ost as ost,
			video_visual as videoVisual,
			production as production
		from watch_point 
		where review_comment_No = #{reviewCommentNo}
	
	</select>
	<select id="selectWatchPointAvg" parameterType="_int" resultType="review">
		select
			trunc(avg(movie_score)) as movieScoreAvg
			from watch_point join review using(review_comment_no)
		where 
			movie_no=#{_parameter}
	</select>
	<select id="selectWatchPointSum" parameterType="_int" resultType="watchPoint">
		select
			sum(story) as story,
			sum(actor) as actor,
			sum(ost) as ost,
			sum(video_visual) as videoVisual,
			sum(production) as production
		from review join watch_point using(review_comment_no)
        where movie_no=#{movieNo}	
	</select>
	<select id="ReviewListCount" parameterType="_int" resultType="_int">
		 select 
		 	count(review_comment_no) as reviewListCount
		 from review 
		 where movie_no=#{movieNo}
	</select>
	
	<select id="selectOneUpdateMovie" parameterType="_int" resultMap="getMovie">
		select 
				*
		from movie_tbl where movie_no=#{movieNo}
	</select>
	<resultMap type="movie" id="getMovie">
	<result column="movie_no" property="movieNo"/>
	<result column="movie_title" property="movieTitle"/>
	<result column="movie_director" property="movieDirector"/>
	<result column="movie_actor" property="movieActor"/>
	<result column="movie_genre" property="movieGenre"/>
	<result column="movie_time" property="movieTime"/>
	<result column="movie_date" property="movieDate"/>
	<result column="movie_rating" property="movieRating"/>
	<result column="movie_content" property="movieContent"/>
	<result column="film_society" property="filmSociety"/>
	<result column="classic_society" property="classicSociety"/>
	<result column="special_movie" property="specialMovie"/>
	<result column="enroll_member" property="enrollMember"/>
	<collection 
	property="moviePost" 
	select="selectMoviePost" 
	column="movie_no"
	ofType="Movie"
	javaType="java.util.ArrayList"
	/>
	<collection 
	property="movieVideos" 
	select="selectOneMovieVideo" 
	column="movie_no"
	ofType="MovieVideo"
	javaType="java.util.ArrayList"
	/>
</resultMap>
<update id="updateMovie" parameterType="movie">
	update movie_tbl set 
		movie_title=#{movieTitle}, movie_director=#{movieDirector}, movie_actor=#{movieActor}, movie_genre=#{movieGenre}, movie_time=#{movieTime}, movie_date=#{movieDate}, movie_rating=#{movieRating}, movie_content=#{movieContent}, film_society=#{filmSociety}, classic_society=#{classicSociety}, special_movie=#{specialMovie}, movie_type=#{movieType}
	where movie_no=#{movieNo}
</update>
<delete id="delteMovie" parameterType="_int">
	delete from movie_tbl where movie_file_no=#{movieNo}
</delete>
<delete id="deleteFile" parameterType="map">
	delete from movie_file where movie_file_no=
	<foreach collection="fileArray" item="fileno" open="(" close=")" separator=",">
		#{fileno}
	</foreach>
</delete>
<delete id="deleteVideo" parameterType="map">
delete from movie_video where movie_video_no=
	<foreach collection="fileArray" item="videoNo" open="(" close=")" separator=",">
		#{videoNo}
	</foreach>
</delete>
<update id="updateReview" parameterType="review">
	update review set
		review_content=#{reviewContent}, movie_score=#{movieScore} where review_comment_no=#{reviewCommentNo} 
</update>
<update id="updateWatchPoint" parameterType="watchPoint">
	update watch_point watch_point set story=#{story},actor=#{actor},ost=#{ost},video_visual=#{videoVisual},production=#{production} where review_comment_no=#{reviewCommentNo}
</update>
<delete id="deleteReview" parameterType="_int">
	delete from review where review_comment_no=#{_parameter}
</delete>
<delete id="deleteWatchPoint" parameterType="_int">
	delete from watch_point where review_comment_no=#{_parameter}
</delete>


</mapper>
